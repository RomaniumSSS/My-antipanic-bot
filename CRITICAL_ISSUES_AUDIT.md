# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî Audit (18.12.2025)

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (39/39).

---

## ‚úÖ –ß—Ç–æ –≤ –ø–æ—Ä—è–¥–∫–µ

1. **CallbackData**: –í—Å–µ handlers –∏—Å–ø–æ–ª—å–∑—É—é—Ç `CallbackData` subclasses, –Ω–µ—Ç raw strings
2. **await**: –í—Å–µ DB –∏ AI –≤—ã–∑–æ–≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `await`
3. **Middleware**: ErrorHandlingMiddleware –∏ AccessMiddleware –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
4. **Claude API**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `AsyncAnthropic`, `max_tokens` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
5. **–†–æ—É—Ç–µ—Ä—ã**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `dp.include_routers()`
6. **callback.answer()**: –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ `edit_text()`, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ prefetch_related

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü–æ—Å–ª–µ `prefetch_related("stages")` –¥–µ–ª–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å `await goal.stages.all()`.
–≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç N+1 –ø—Ä–æ–±–ª–µ–º—É –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É.

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã
- `src/bot/handlers/start.py:78`
- `src/bot/handlers/manage_goals.py:116, 160, 239, 306, 387`

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–¥–∞
```python
# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
goal = await Goal.filter(...).prefetch_related("stages").first()
stages = await goal.stages.all().order_by("order")  # –î—É–±–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å!
```

### –†–µ—à–µ–Ω–∏–µ
Tortoise ORM –ù–ï –∫—ç—à–∏—Ä—É–µ—Ç prefetch_related –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
from src.storage import goal_repo

goal = await goal_repo.get_goal(goal_id)
stages = await goal_repo.get_all_stages(goal)  # –û—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–æ —è–≤–Ω—ã–π
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –£–¥–∞–ª–∏—Ç—å prefetch –∏ –¥–µ–ª–∞—Ç—å —è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å**
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
goal = await Goal.get_or_none(id=goal_id)
stages = await Stage.filter(goal=goal).order_by("order").all()
```

---

## üü° –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. N+1 –≤ check_user.py (—Å–∫—Ä–∏–ø—Ç)
**–§–∞–π–ª**: `scripts/ops/check_user.py:28-33`

```python
# ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
goals = await Goal.filter(user=user).prefetch_related("stages__steps")
for goal in goals:
    stages = await Stage.filter(goal=goal)  # N+1!
```

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ stages —á–µ—Ä–µ–∑ `await goal.stages.all()` –∏–ª–∏ —É–±—Ä–∞—Ç—å prefetch.

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ prefetch_related
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `prefetch_related("stages")` ‚Üí `goal_repo.get_all_stages(goal)`
- [ ] –ò–ª–∏ —É–¥–∞–ª–∏—Ç—å prefetch –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —è–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤ `TORTOISE_RULES.md` —è–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –æ prefetch

### 2. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ N+1
```python
# tests/test_n_plus_one.py
async def test_goal_stages_queries():
    # Assert: –Ω–µ –±–æ–ª–µ–µ 2 –∑–∞–ø—Ä–æ—Å–æ–≤ (1 goal + 1 stages batch)
    ...
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å production –ª–æ–≥–∏
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Tortoise SQL –ª–æ–≥–∏ –Ω–∞ production:
```python
TORTOISE_ORM["logging"] = {"level": "DEBUG"}  # –≤—Ä–µ–º–µ–Ω–Ω–æ
```

---

## –í–µ—Ä–¥–∏–∫—Ç

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–µ—Ä–æ–≤ –Ω–µ—Ç**, –Ω–æ –µ—Å—Ç—å **–ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å-–ø—Ä–æ–±–ª–µ–º–∞** —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.
–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–µ–ª–∞–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã. –ù–∞ Railway —Å PostgreSQL —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π latency
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏—é –ª–∏–º–∏—Ç–æ–≤ DB connections

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°—Ä–µ–¥–Ω–∏–π (–Ω–µ –±–ª–æ–∫–µ—Ä, –Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–æ–∏—Ç)

