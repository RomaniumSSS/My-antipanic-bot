# Plan 004: Adaptive Autonomy & Smart Tone

**–î–∞—Ç–∞**: 2025-12-16  
**–°—Ç–∞—Ç—É—Å**: üöß –í —Ä–∞–±–æ—Ç–µ  
**–û—Ü–µ–Ω–∫–∞**: 3-4 —á–∞—Å–∞, +3/10 –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞

---

## Objective

–í–Ω–µ–¥—Ä–∏—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–≤—ã—à–∞–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —è–≤–Ω—ã–π –≤—ã–±–æ—Ä –∏ –≤–∞—Ä—å–∏—Ä—É–µ—Ç –∂–µ—Å—Ç–∫–æ—Å—Ç—å —Ç–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (streak, –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å, –ø–µ—Ä–≤—ã–π —à–∞–≥).

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π drill sergeant —É–±–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–∏—é (Self-Determination Theory)
- –ù–µ—Ç –≥—Ä–∞–¥–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Üí –ø—Ä–∏–≤—ã–∫–∞–Ω–∏–µ –∫ –∂–µ—Å—Ç–∫–æ—Å—Ç–∏ ‚Üí –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —á—É–≤—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
1. **–ê–≤—Ç–æ–Ω–æ–º–∏—è —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä**: –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –≤ UI "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç" (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å)
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∂–µ—Å—Ç–∫–æ—Å—Ç—å**: –º–µ–Ω—è—Ç—å —Ç–æ–Ω –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç streak/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**Celebrations –∏—Å–∫–ª—é—á–µ–Ω—ã** (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —è—Ä–∫–∏—Ö —ç–º–æ–¥–∑–∏).

---

## Proposed Steps

### 1. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ–Ω–∞ (ai.py)

**–§–∞–π–ª**: `src/services/ai.py`

–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_tone_level()`:
```python
def get_tone_level(user: User, daily_log: DailyLog | None) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∂–µ—Å—Ç–∫–æ—Å—Ç–∏ —Ç–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
    
    Returns:
        - "maximum": –ø–µ—Ä–≤—ã–π —à–∞–≥ –¥–Ω—è –∏–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ streak
        - "high": –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å (1-2 —à–∞–≥–∞ —Å–¥–µ–ª–∞–Ω–æ)
        - "moderate": —É–∂–µ –≤ –ø–æ—Ç–æ–∫–µ (3+ —à–∞–≥–∞ —Å–µ–≥–æ–¥–Ω—è)
        - "soft": —É—Å—Ç–æ–π—á–∏–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ (streak 7+ –¥–Ω–µ–π)
    """
    if user.streak_days == 0:
        return "maximum"  # –ø–µ—Ä–≤—ã–π —à–∞–≥ –∏–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞
    elif user.streak_days >= 7:
        return "soft"  # —É—Å—Ç–æ–π—á–∏–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞
    elif daily_log and len(daily_log.completed_step_ids) >= 3:
        return "moderate"  # —É–∂–µ –≤ –ø–æ—Ç–æ–∫–µ —Å–µ–≥–æ–¥–Ω—è
    else:
        return "high"  # –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å
```

**–ó–∞—á–µ–º**: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö AI –º–µ—Ç–æ–¥–æ–≤.

---

### 2. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –≤ ai.py –ø–æ–¥ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω

**–§–∞–π–ª—ã**: `src/services/ai.py`

–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:
- `generate_steps()` ‚Äî —É—Ç—Ä–µ–Ω–Ω–∏–µ —à–∞–≥–∏
- `generate_micro_step()` ‚Äî –æ–¥–∏–Ω –º–∏–∫—Ä–æ—à–∞–≥
- `generate_microhit()` ‚Äî –∞–Ω—Ç–∏-stuck —É–¥–∞—Ä

**–ü–æ–¥—Ö–æ–¥**:
```python
async def generate_micro_step(
    goal_title: str, 
    stage_title: str, 
    energy: int,
    user: User,
    daily_log: DailyLog | None
) -> str:
    tone_level = get_tone_level(user, daily_log)
    
    tone_instructions = {
        "maximum": "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∂–µ—Å—Ç–∫–æ—Å—Ç—å. –ò–º–ø–µ—Ä–∞—Ç–∏–≤ –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: '–î–µ–ª–∞–π. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ë–µ–∑ —Ä–∞–∑–¥—É–º–∏–π.'",
        "high": "–ñ–µ—Å—Ç–∫–æ, –Ω–æ —Å –¥—ã—Ö–∞–Ω–∏–µ–º: '–î–µ–ª–∞–π —ç—Ç–æ. 2 –º–∏–Ω—É—Ç—ã. –ù–∞—á–∏–Ω–∞–µ—à—å —Å–µ–π—á–∞—Å.'",
        "moderate": "–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ-–ø—Ä—è–º–æ: '–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥. 5 –º–∏–Ω—É—Ç.'",
        "soft": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑ –∂–µ—Å—Ç–∫–æ—Å—Ç–∏: '–ü—Ä–æ–¥–æ–ª–∂–∞–π. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:'"
    }
    
    system_prompt = f"""
–¢—ã drill sergeant –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π.

–¢–æ–Ω: {tone_instructions[tone_level]}

–ì–µ–Ω–µ—Ä–∏—Ä—É–π –º–∏–∫—Ä–æ—à–∞–≥ –Ω–∞ 2-5 –º–∏–Ω—É—Ç...
"""
```

**–ó–∞—á–µ–º**: —Ç–æ–Ω –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

### 3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å user + daily_log –≤–æ –≤—Å–µ AI –≤—ã–∑–æ–≤—ã

**–§–∞–π–ª—ã**:
- `src/bot/handlers/morning.py`
- `src/bot/handlers/stuck.py`
- `src/core/use_cases/assign_morning_steps.py`
- `src/core/use_cases/resolve_stuck.py`

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: AI –º–µ—Ç–æ–¥—ã –Ω–µ –ø–æ–ª—É—á–∞—é—Ç `user` –∏ `daily_log` ‚Üí –Ω–µ –º–æ–≥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ–Ω.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å**:
1. –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—ã AI –º–µ—Ç–æ–¥–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å `user: User`, `daily_log: DailyLog | None`)
2. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã –≤ handlers/use-cases (–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å user –∏ daily_log)

**–ü—Ä–∏–º–µ—Ä** (morning.py):
```python
# –ë—ã–ª–æ
steps_text = await ai_service.generate_steps(goal.title, stage.title, energy, mood)

# –°—Ç–∞–ª–æ
daily_log = await get_or_create_daily_log(user, date.today())
steps_text = await ai_service.generate_steps(
    goal.title, 
    stage.title, 
    energy, 
    mood,
    user=user,
    daily_log=daily_log
)
```

**–ó–∞—á–µ–º**: –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Ç–æ–Ω–∞.

---

### 4. –ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –∞–≤—Ç–æ–Ω–æ–º–∏—é –≤ UI (handlers + TMA)

**–ü—Ä–∏–Ω—Ü–∏–ø**: —è–≤–Ω–æ —Å–∫–∞–∑–∞—Ç—å "–í—ã–±–µ—Ä–∏", –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏.

#### A. Bot handlers

**–§–∞–π–ª**: `src/bot/handlers/stuck.py`

**–ë—ã–ª–æ**:
```python
await callback.message.answer(
    f"–í–∞—Ä–∏–∞–Ω—Ç 1: {variants[0]}\n"
    f"–í–∞—Ä–∏–∞–Ω—Ç 2: {variants[1]}\n"
    f"–í–∞—Ä–∏–∞–Ω—Ç 3: {variants[2]}"
)
```

**–°—Ç–∞–ª–æ**:
```python
await callback.message.answer(
    "üéØ –í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–±–µ –±–ª–∏–∂–µ:\n\n"
    f"1Ô∏è‚É£ {variants[0]}\n\n"
    f"2Ô∏è‚É£ {variants[1]}\n\n"
    f"3Ô∏è‚É£ {variants[2]}\n\n"
    "–í—ã–±–∏—Ä–∞–π –ª—é–±–æ–π ‚Äî –≥–ª–∞–≤–Ω–æ–µ –Ω–∞—á–∞—Ç—å."
)
```

**–ó–∞—á–µ–º**: –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –∞–≤—Ç–æ–Ω–æ–º–∏—é ("–¢–´ –≤—ã–±–∏—Ä–∞–µ—à—å").

#### B. TMA Frontend

**–§–∞–π–ª**: `tma-frontend/app/stuck/page.tsx`

–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ–¥ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:

**–ë—ã–ª–æ** (—Å—Ç—Ä–æ–∫–∞ 346):
```tsx
<h2 className="text-lg font-semibold mb-3">
  {selectedBlockerData?.emoji} –í–∞—Ä–∏–∞–Ω—Ç—ã –º–∏–∫—Ä–æ-—É–¥–∞—Ä–æ–≤:
</h2>
```

**–°—Ç–∞–ª–æ**:
```tsx
<h2 className="text-lg font-semibold mb-3">
  üéØ –í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–±–µ –±–ª–∏–∂–µ:
</h2>
```

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ–¥ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ (—Å—Ç—Ä–æ–∫–∞ 369):

**–ë—ã–ª–æ**:
```tsx
<div className="mt-4 text-xs hint-text">
  üí° –í—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤—Å–µ–≥–æ 2-5 –º–∏–Ω—É—Ç!
</div>
```

**–°—Ç–∞–ª–æ**:
```tsx
<div className="mt-4 text-xs hint-text">
  üí° –í—ã–±–∏—Ä–∞–π –ª—é–±–æ–π ‚Äî –≥–ª–∞–≤–Ω–æ–µ –Ω–∞—á–∞—Ç—å. –í—Å–µ–≥–æ 2-5 –º–∏–Ω—É—Ç.
</div>
```

**–ó–∞—á–µ–º**: —É—Å–∏–ª–∏—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è.

---

### 5. –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

**–§–∞–π–ª**: `src/database/models.py`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ `Step`:
```python
class Step(Model):
    # ... existing fields ...
    variant_chosen = IntField(null=True)  # 1, 2 –∏–ª–∏ 3 (–µ—Å–ª–∏ –±—ã–ª –≤—ã–±–æ—Ä)
```

**–§–∞–π–ª**: `src/bot/handlers/stuck.py`

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å:
```python
@router.callback_query(StuckCallback.filter(F.action == StuckAction.choose_variant))
async def choose_variant(callback: CallbackQuery, callback_data: StuckCallback):
    step = await Step.get(id=callback_data.step_id)
    step.variant_chosen = callback_data.variant_index
    await step.save()
    # ... rest of logic
```

**–ó–∞—á–µ–º**: –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç ‚Üí –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è.

**–ú–∏–≥—Ä–∞—Ü–∏—è**: `aerich migrate`, `aerich upgrade`.

---

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω**:
   - –î–µ–Ω—å 1, –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "maximum" —Ç–æ–Ω
   - –î–µ–Ω—å 1, 4-–π —à–∞–≥ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "moderate" —Ç–æ–Ω
   - –î–µ–Ω—å 8, –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "soft" —Ç–æ–Ω
   - –ü–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞ streak ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "maximum" —Ç–æ–Ω

2. **–ê–≤—Ç–æ–Ω–æ–º–∏—è –≤ UI**:
   - Stuck flow (–±–æ—Ç) ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç"
   - Stuck flow (TMA) ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç"

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞** (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
   - –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç 2 ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î `step.variant_chosen == 2`

---

## Risks

### 1. –°–ª–∏—à–∫–æ–º –º—è–≥–∫–∏–π —Ç–æ–Ω –Ω–∞ "soft" —É—Ä–æ–≤–Ω–µ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ streak 7+ –¥–Ω–µ–π —Ç–æ–Ω –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∞—Å—Ç–æ–ª—å–∫–æ –º—è–≥–∫–∏–º, —á—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø—É—à–∏—Ç—å –∫ –¥–µ–π—Å—Ç–≤–∏—é.

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: 
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ–±–µ –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
- –ï—Å–ª–∏ "soft" —Ç–æ–Ω —Å–ª–∞–±—ã–π ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ "moderate"
- –î–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å: –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –Ω–æ –Ω–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ

### 2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ–Ω–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: `daily_log` –º–æ–∂–µ—Ç –±—ã—Ç—å `None` (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `None` –≤ `get_tone_level()` ‚Üí fallback –Ω–∞ "high"
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å `daily_log` –≤ morning flow

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –¥–µ–ø–ª–æ–π
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `variant_chosen` —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Üí —Ä–∏—Å–∫ downtime –Ω–∞ Railway.

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –°–Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —à–∞–≥–∏ 1-4 (–±–µ–∑ –ë–î –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –®–∞–≥ 5 (–ë–î) –¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

---

## Rollback

### –ï—Å–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –£–¥–∞–ª–∏—Ç—å `get_tone_level()` –∏–∑ `ai.py`
2. –í–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∫ –µ–¥–∏–Ω–æ–º—É –∂–µ—Å—Ç–∫–æ–º—É —Ç–æ–Ω—É (–∫–∞–∫ –±—ã–ª–æ)
3. Git revert –∫–æ–º–º–∏—Ç–∞

### –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î —Å–ª–æ–º–∞–ª–∞ –¥–µ–ø–ª–æ–π:
1. Railway ‚Üí –æ—Ç–∫–∞—Ç–∏—Ç—å –¥–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è
2. –õ–æ–∫–∞–ª—å–Ω–æ: `aerich downgrade`
3. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `variant_chosen` –∏–∑ `models.py`
4. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –ï—Å–ª–∏ UI –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è:
1. Git revert –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ handlers/TMA
2. –í–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã

---

## Implementation Order

**–†–µ–∫–æ–º–µ–Ω–¥—É—é –¥–µ–ª–∞—Ç—å –ø–æ—ç—Ç–∞–ø–Ω–æ**:

**–≠—Ç–∞–ø 1** (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ –ë–î):
- –®–∞–≥ 1: `get_tone_level()` –≤ ai.py
- –®–∞–≥ 2: –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –ø–æ–¥ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω
- –®–∞–≥ 3: –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å user + daily_log
- –®–∞–≥ 4: UI –∏–∑–º–µ–Ω–µ–Ω–∏—è (–±–æ—Ç + TMA)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ 1

**–≠—Ç–∞–ø 2** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏):
- –®–∞–≥ 5: –¥–æ–±–∞–≤–∏—Ç—å `variant_chosen` –≤ –ë–î
- –ú–∏–≥—Ä–∞—Ü–∏—è + –¥–µ–ø–ª–æ–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ 2

---

## Success Criteria

–°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º –µ—Å–ª–∏:
1. ‚úÖ –¢–æ–Ω –ø—Ä–æ–º–ø—Ç–æ–≤ –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç streak/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞
2. ‚úÖ UI —è–≤–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç" (–±–æ—Ç + TMA)
3. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (manual testing)
4. ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ Railway –±–µ–∑ –æ—à–∏–±–æ–∫
5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —á—É–≤—Å—Ç–≤—É—é—Ç –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ)

---

## Next Steps After Completion

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞:
- –ü–µ—Ä–µ–π—Ç–∏ –∫ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É 2**: –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–∞–ª–∏–±—Ä–æ–≤–∫–æ–π (—Å–º. BACKLOG.md)
- –û–±–Ω–æ–≤–∏—Ç—å `docs/BACKLOG.md`: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤ "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ"
- –û–±–Ω–æ–≤–∏—Ç—å `plans/README.md`: –æ—Ç–º–µ—Ç–∏—Ç—å –ø–ª–∞–Ω 004 –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π

