# Инструкции для AI Агентов

Этот файл содержит критически важные инструкции для любого AI-агента или LLM, работающего с этим репозиторием Antipanic Bot.

## 1. Протокол Инициализации (ОБЯЗАТЕЛЬНО)
**Прежде чем приступать к выполнению любой задачи, вы должны:**
1. Прочитать `README.md` в корне проекта.
2. Прочитать **ВСЕ** файлы в директории `docs/`:
   - `product.md` — бизнес-логика, user flow
   - `tech.md` — архитектура, стек
   - `AIOGRAM_RULES.md` — **ОБЯЗАТЕЛЬНО** при работе с ботом
   - `TORTOISE_RULES.md` — **ОБЯЗАТЕЛЬНО** при работе с БД
   - `OPENAI_RULES.md` — при работе с AI сервисом
   - `APSCHEDULER_RULES.md` — при работе с напоминаниями

> Почему это важно? Вы не можете эффективно работать над проектом, не понимая его архитектуру, бизнес-логику и текущий статус, описанные в документации. Не галлюцинируйте — изучите документацию.

## 2. Политика Ведения Документации
**Если вы вносите ЗНАЧИМЫЕ изменения, вы ОБЯЗАНЫ обновить документацию.**
Значимые изменения: глобальный user flow, архитектура, новые ключевые модули/сервисы, изменения API или структур данных, бизнес-правила.
Не требуются обновления для: простых рефакторов без изменения логики, рядовых зависимостей, мелких багфиксов.
Действия: после изменений проверьте, соответствует ли `docs/` новой реальности; если нет — обновите в том же PR/коммите.

## 3. Базовые принципы (Core Principles)
1. **Documentation-First Development** — каждая сессия начинается с чтения `docs/`.
2. **Instruction-First** — простые задачи: следуем запросу; сложные: сначала план.
3. **Keep It Simple (MVP)** — делаем MVP, избегаем оверинжиниринга; используем стек из `docs/tech.md` (aiogram, Tortoise ORM, SQLite, OpenAI API, APScheduler).
4. **Одна боль → действие** — весь функционал крутится вокруг снятия паралича и запуска микрошагов.

## 4. Режим планирования (Plan Mode)
Считай задачу сложной, если затрагивает несколько модулей, новые интеграции, миграции/схему БД, архитектурные изменения. При сомнениях — тоже сложная.
Процесс:
1. Создай `plans/NNN-objective.md` (NNN — инкремент).
2. Структура: Objective (цель дословно из запроса), Proposed Steps (нумерованный список), Risks, Rollback.
Правило: не начинай реализацию сложной задачи, пока человек не утвердит план.

## 5. Система памяти AICODE (Context Anchors)
Оставляй "хлебные крошки" в коде для неочевидных решений, долга и вопросов.
- `AICODE-NOTE:` архитектурное решение или хак, почему так.
- `AICODE-TODO:` технический долг/недоделка, что сделать позже.
- `AICODE-QUESTION:` блокер/вопрос для уточнения.

## 6. Технические правила (Vibe-Coding Style)
1. Стек: Python 3.11+, aiogram 3.x, Tortoise ORM, SQLite, OpenAI API, APScheduler.
2. Асинхронность: весь I/O (БД, Telegram, внешние API) — `async/await`.
3. Структура: соблюдай дерево из `docs/tech.md`; не плодить файлы в корне, если им место в `handlers/`, `services/` и т.д.
4. Безопасность: токены только в `.env`; не хардкодить секреты.

### 6.1 aiogram 3.x (КРИТИЧНО)
**Читай `docs/AIOGRAM_RULES.md` перед любой работой с ботом!**

Ключевые правила:
- **CallbackData Factory** — НИКОГДА не используй raw строки для `callback_data`. Всегда `CallbackData` subclass.
- **Magic Filter F** — используй `F.text`, `F.from_user.id`, комбинируй через `&` / `|`.
- **CallbackAnswerMiddleware** — регистрируй на dispatcher, чтобы auto-answer callbacks.
- **FSM** — состояния в `StatesGroup`, данные через `state.update_data()`.
- **Роутеры** — один роутер на флоу (`start`, `morning`, `stuck`, `evening`).

### 6.2 Tortoise ORM (КРИТИЧНО)
**Читай `docs/TORTOISE_RULES.md` перед работой с БД!**

Ключевые правила:
- **prefetch_related** — всегда используй для связей, избегай N+1.
- **await** — перед ВСЕМИ запросами к БД.
- **Типизация** — `ForeignKeyRelation`, `ReverseRelation` для type hints.

### 6.3 OpenAI API
**Читай `docs/OPENAI_RULES.md` при работе с AI.**

Ключевые правила:
- **AsyncOpenAI** — только async клиент.
- **Retry** — tenacity для transient errors.
- **Промпты** — выноси в константы, структурируй.

### 6.4 APScheduler
**Читай `docs/APSCHEDULER_RULES.md` при работе с напоминаниями.**

Ключевые правила:
- **AsyncScheduler** — только async.
- **conflict_policy** — указывай при добавлении schedules с фиксированным ID.
- **Lifecycle** — start в `on_startup`, stop в `on_shutdown`.

## 7. Самопроверка перед завершением
Перед "Готово" проверь:
1. Код соответствует задаче?
2. Если был план — выполнены ли шаги на этот этап?
3. AICODE: оставлены ли `NOTE`/`TODO` в спорных местах?
4. Документация обновлена при изменениях?
5. Код опрятен (PEP8); линтеры по необходимости.
