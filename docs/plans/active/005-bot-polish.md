# –ü–ª–∞–Ω 005: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞ –±–æ—Ç–∞

**–°—Ç–∞—Ç—É—Å**: –ù–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏  
**–î–∞—Ç–∞**: 2025-12-17  
**–¶–µ–ª—å**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –ª–æ–º–∞—é—Ç –ª–æ–≥–∏–∫—É –∏–ª–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ç—Ä–∞—Ç–∞–º.

---

## 1. üö® –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Üí –¥—É–±–ª–∏ —à–∞–≥–æ–≤, –ª–∏—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã AI, —Ç—Ä–∞—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `processing=True` –≤ FSM state –≤ –Ω–∞—á–∞–ª–µ handler'–∞
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ñ–ª–∞–≥: –µ—Å–ª–∏ True ‚Üí `callback.answer("–£–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...")` –∏ return
- –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å `callback.answer()` –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ handler'–∞
- –£–¥–∞–ª—è—Ç—å inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è (`reply_markup=None`)
- –í –±–ª–æ–∫–µ `finally` —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–ª–∞–≥ `processing=False`

**–ì–¥–µ**: `morning.py`, `steps.py`, `stuck.py`, `evening.py` ‚Äî –≤—Å–µ callback handlers.

---

## 2. üí∞ Rate Limiting –¥–ª—è AI

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –ª–∏–º–∏—Ç–æ–≤ ‚Üí –º–æ–∂–Ω–æ —Å–ø–∞–º–∏—Ç—å /morning –∏ /stuck ‚Üí –æ–≥—Ä–æ–º–Ω—ã–µ —Å—á–µ—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `ai_calls_count: int` –≤ –º–æ–¥–µ–ª—å `DailyLog`
- –°–æ–∑–¥–∞—Ç—å `src/services/rate_limiter.py`:
  - `async def check_ai_limit(user, action) -> (bool, str)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
  - `async def increment_ai_calls(user)` ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
- –õ–∏–º–∏—Ç—ã: **3 morning + 5 stuck –≤ –¥–µ–Ω—å**
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ AI –≤—ã–∑–æ–≤–∞–º–∏ –≤ `morning.py` –∏ `stuck.py`
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/limits` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI –∑–∞ –¥–µ–Ω—å
- –ú–∏–≥—Ä–∞—Ü–∏—è: `aerich migrate --name "add_ai_calls_count"`

**–ì–¥–µ**: `morning.py` (–ø–µ—Ä–µ–¥ `assign_morning_steps_use_case`), `stuck.py` (–ø–µ—Ä–µ–¥ `generate_microhit_options`).

---

## 3. ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ user/goal/stage ‚Üí –ø–∞–¥–µ–Ω–∏—è `AttributeError: 'NoneType'`.

**–†–µ—à–µ–Ω–∏–µ** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ handler'–∞:
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ `callback.from_user` (–µ—Å–ª–∏ None ‚Üí return)
2. –ü–æ–ª—É—á–∏—Ç—å `user = await User.get_or_none(...)` ‚Üí –µ—Å–ª–∏ None ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ + `state.clear()` + return
3. –ü–æ–ª—É—á–∏—Ç—å `goal` –∏–∑ FSM data ‚Üí –µ—Å–ª–∏ None ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ + `state.clear()` + return
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `stage = await ensure_active_stage(goal)` ‚Üí –µ—Å–ª–∏ None ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ + return

**–ì–¥–µ**: 
- `morning.py`: `handle_tension_before`, `handle_tension_after`, `handle_deepen_choice`
- `steps.py`: `step_done`, `step_skip`, `step_stuck`
- `stuck.py`: `generate_and_show_microhit_options`, `microhit_option_selected`
- `evening.py`: `cmd_evening`

---

## 4. üõ°Ô∏è AI Fallback –∏ timeout

**–ü—Ä–æ–±–ª–µ–º–∞**: AI –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–∞—Ç—å (60s), –ø—Ä–∏ –æ—à–∏–±–∫–µ –±–æ—Ç –º–æ–ª—á–∏—Ç, –ø—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ**:
- –°–æ–∫—Ä–∞—Ç–∏—Ç—å timeout –¥–æ **30s** –≤ `src/services/ai.py`
- –ü—Ä–∏ `asyncio.TimeoutError` –∏ `Exception` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `[]` (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)
- –î–æ–±–∞–≤–∏—Ç—å fallback –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É: `FALLBACK_STEPS = ["–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª", "–ù–∞–ø–∏—à–∏ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É", ...]`
- –ü—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ AI ‚Üí –≤–µ—Ä–Ω—É—Ç—å `FALLBACK_STEPS[:1]`
- –í handlers –ø—Ä–æ–≤–µ—Ä—è—Ç—å `if not result.success or not result.step:` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑"

**–ì–¥–µ**: `src/services/ai.py` (–≤—Å–µ –º–µ—Ç–æ–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏), `morning.py`, `stuck.py` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤).

---

## 5. üîß Edge Cases –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–ª–æ—É

**–ü—Ä–æ–±–ª–µ–º–∞**: –§–ª–æ—É –ª–æ–º–∞—é—Ç—Å—è –Ω–∞ –∫—Ä–∞–π–Ω–∏—Ö —Å–ª—É—á–∞—è—Ö (–Ω–µ—Ç —Ü–µ–ª–∏, –µ—Å—Ç—å —à–∞–≥–∏, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤).

**–†–µ—à–µ–Ω–∏–µ**:
- **Morning**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `DailyLog.assigned_step_ids` ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å pending —à–∞–≥–∏, –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –≤–º–µ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö
- **Stuck**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Ü–µ–ª–∏ –≤ –Ω–∞—á–∞–ª–µ ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–æ–∑–¥–∞–π —Ü–µ–ª—å —á–µ—Ä–µ–∑ /start"
- **Evening**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —à–∞–≥–æ–≤ —á–µ—Ä–µ–∑ `get_daily_summary()` ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–∞–ø–∏—à–∏ /morning"
- **Steps**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `step = await Step.get_or_none(id=step_id)` ‚Üí –µ—Å–ª–∏ None, —Å–æ–æ–±—â–µ–Ω–∏–µ "–®–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ì–¥–µ**: `morning.py` (`cmd_morning`), `stuck.py` (`cmd_stuck`), `evening.py` (`cmd_evening`), `steps.py` (–≤—Å–µ handlers).

---

## 6. üÜò –ö–æ–º–∞–Ω–¥–∞ /cancel –∏ fallback handler

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –≤ FSM state, –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞", –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –∫–∞–∫ –≤—ã–π—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/cancel` ‚Üí –æ—á–∏—Å—Ç–∫–∞ FSM state, –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- –°–æ–∑–¥–∞—Ç—å `src/bot/handlers/fallback.py`:
  - –†–æ—É—Ç–µ—Ä —Å `@router.message()` (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
  - –ï—Å–ª–∏ `current_state` ‚Üí "–ù–µ –ø–æ–Ω—è–ª. –ò—Å–ø–æ–ª—å–∑—É–π /cancel –∏–ª–∏ /help"
  - –ï—Å–ª–∏ –Ω–µ—Ç state ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ + –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å **–ø–æ—Å–ª–µ–¥–Ω–∏–º** –≤ `register_routers()`
- –û–±–Ω–æ–≤–∏—Ç—å `/help` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `/cancel` –∏ `/limits`

**–ì–¥–µ**: `start.py` (–∫–æ–º–∞–Ω–¥–∞ `/cancel`), –Ω–æ–≤—ã–π —Ñ–∞–π–ª `fallback.py`, `handlers/__init__.py` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è).

---

## Implementation Plan

### Phase 1: –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–ª–∏–∫–æ–≤ + –ø—Ä–æ–≤–µ—Ä–∫–∏ (1.5 —á)
- –§–ª–∞–≥ `processing` –≤–æ –≤—Å–µ callback handlers
- `callback.answer()` –≤–µ–∑–¥–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∏ user/goal/stage
- –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

### Phase 2: Rate limiting (1 —á)
- –ü–æ–ª–µ `ai_calls_count` –≤ DailyLog
- `rate_limiter.py` (check + increment)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ AI –≤—ã–∑–æ–≤–∞–º–∏
- –ö–æ–º–∞–Ω–¥–∞ `/limits`
- –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

### Phase 3: AI Fallback + Edge Cases (1 —á)
- Timeout 30s –≤ `ai.py`
- Fallback —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- Edge cases –≤ morning/stuck/evening

### Phase 4: /cancel –∏ fallback (30 –º–∏–Ω)
- –ö–æ–º–∞–Ω–¥–∞ `/cancel`
- –§–∞–π–ª `fallback.py`
- –û–±–Ω–æ–≤–∏—Ç—å `/help`

### Phase 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á)
- –í—Å–µ —Ñ–ª–æ—É –≤—Ä—É—á–Ω—É—é
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏
- –õ–∏–º–∏—Ç—ã AI
- Edge cases
- /cancel

**–û–±—â–µ–µ –≤—Ä–µ–º—è: ~5 —á–∞—Å–æ–≤**

---

## Success Criteria

- [ ] –ù–µ–ª—å–∑—è –∫–ª–∏–∫–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –¥–≤–∞–∂–¥—ã
- [ ] –õ–∏–º–∏—Ç 3 morning + 5 stuck AI calls/–¥–µ–Ω—å
- [ ] –í—Å–µ handlers –∏–º–µ—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ user/goal/stage
- [ ] AI timeout 30s + fallback
- [ ] Edge cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- [ ] /cancel —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Fallback handler –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ

## Rollback

```bash
git revert HEAD~N
aerich downgrade
python -m src.main
```

---

---

## üî¥ –î–û–ü–û–õ–ù–ï–ù–ò–ï: –†–µ–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –∏–∑ user testing (17.12.2025)

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏ (—Ñ–∏–∫—Å–∏–º –ü–ï–†–í–´–ú–ò):

**7. `/evening` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π**
- **–ü—Ä–æ–±–ª–µ–º–∞**: `evening.py` ‚Üí `cmd_evening` –ø–∞–¥–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ**: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ user/goal, –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å edge cases

**8. –§–∏–ª—å—Ç—Ä —à–∞–≥–æ–≤ –ø–æ –¥–∞—Ç–µ**
- **–ü—Ä–æ–±–ª–µ–º–∞**: "–®–∞–≥–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï —à–∞–≥–∏ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è
- **–†–µ—à–µ–Ω–∏–µ**: –≤ `get_daily_summary()` —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `scheduled_date = today`

**9. `/stuck` –Ω–µ –≤–∏–¥–∏—Ç —Ü–µ–ª—å –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —á–µ—Ä–µ–∑ "–¶–µ–ª–∏"**
- **–ü—Ä–æ–±–ª–µ–º–∞**: FSM state –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Ü–µ–ª–∏
- **–†–µ—à–µ–Ω–∏–µ**: –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ü–µ–ª–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `goal_id` –≤ FSM data

**10. –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–∏ /start**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –±–æ—Ç–æ–º
- **–†–µ—à–µ–Ω–∏–µ**: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (3-4 —Å—Ç—Ä–æ–∫–∏)

**11. –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è: "–ü—Ä–æ–π–¥–∏—Å—è" ‚Üí "–ü—Ä–æ–π–¥–∏—Å—å"**
- **–ì–¥–µ**: –ø—Ä–æ–º–ø—Ç—ã –≤ `ai.py`, `FALLBACK_STEPS`
- **–†–µ—à–µ–Ω–∏–µ**: –≥–ª–æ–±–∞–ª—å–Ω—ã–π find&replace

**12. –ö–Ω–æ–ø–∫–∞ "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å `/app`
- **–†–µ—à–µ–Ω–∏–µ**: –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ `keyboards.py:get_main_menu_keyboard()`

---

## Updated Implementation Plan

### Phase 0: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏ (2 —á)
- `/evening` –ø–∞–¥–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∏ + edge cases)
- –§–∏–ª—å—Ç—Ä —à–∞–≥–æ–≤ –ø–æ `scheduled_date = today`
- `/stuck` –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ü–µ–ª–∏ (FSM state sync)
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–∏ `/start` (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
- –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è "–ü—Ä–æ–π–¥–∏—Å—å"
- –ö–Ω–æ–ø–∫–∞ "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"

### Phase 1-5: –ü–æ –ø–ª–∞–Ω—É –≤—ã—à–µ (5 —á)

**–û–±—â–µ–µ –≤—Ä–µ–º—è: ~7 —á–∞—Å–æ–≤**

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.**
