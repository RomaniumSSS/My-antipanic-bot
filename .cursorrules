# Antipanic Bot â€” Cursor Rules

## ğŸš¨ Read First
Before ANY action:
1. `docs/guides/AGENTS.md` â€” initialization protocol
2. Relevant: `docs/guides/AIOGRAM_RULES.md` / `TORTOISE_RULES.md` / `CLAUDE_RULES.md`

Start response: "âœ… Verified: [docs read]"

---

## Anti-Hallucination (Critical)

### aiogram 3.x
- âœ… `CallbackData` subclass (NOT raw strings)
- âœ… `@router.message(Command("start"))` (NOT `@dp.message_handler`)
- âœ… `F.text`, `F.from_user.id` for filters
- âŒ NEVER aiogram 2.x syntax

### Tortoise ORM
- âœ… `await User.get(...)` / `await Model.filter(...).prefetch_related(...)`
- âŒ NEVER forget `await` (returns coroutine)
- âŒ NEVER skip `prefetch_related` (causes N+1)

### Claude (Anthropic)
- âœ… `AsyncAnthropic()` only (NEVER sync client!)
- âœ… `max_tokens` MANDATORY parameter (unlike OpenAI)
- âœ… Drill sergeant tone in prompts (no "Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹", "Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ")
- âŒ NEVER sync client in async
- âŒ NEVER forget `max_tokens` (required by Claude API)

Check `docs/guides/AGENTS.md` Â§ 6-7 and `docs/guides/CLAUDE_RULES.md` for details.

---

## Structure (Enforce)
```
src/bot/handlers/    # One router per flow
src/services/        # Business logic
src/core/            # Domain rules
src/storage/         # Repositories
```
âŒ NO files in root

---

## Code Style
- âœ… `async/await` for ALL I/O
- âœ… Type hints on all functions
- âœ… AICODE-NOTE/TODO/QUESTION for non-obvious code

---

## Documentation Policy

### In Responses
- âŒ NEVER write full usage guides after code changes
- âœ… Brief summary (1â€“2 sentences max) IF critical
- âœ… Inline docstrings/comments in code itself
- âŒ NEVER create multi-paragraph "How to use" sections in chat

### In Files
- âœ… Update existing `docs/` files if architecture changes
- âœ… Map changes to relevant doc:
  - API changes â†’ `docs/tech/tech.md`
  - Domain rules â†’ `docs/product/product.md`
  - Bot flows â†’ `docs/guides/AGENTS.md` Â§ relevant
  - Deployment â†’ `docs/tech/RAILWAY_DEPLOY.md` / `docs/guides/CRON_SETUP.md`
- âŒ NEVER create new standalone doc per feature
- âŒ NEVER write 50+ line usage examples in docs

### Context Economy
- Keep explanations compact (use bullet points, not paragraphs)
- Assume the human can read code; don't re-explain obvious flow
- Reference existing docs instead of repeating content

---

## Plan Mode
Trigger if: multiple modules, DB changes, architecture shifts, new integrations.
Create `docs/plans/active/NNN-objective.md` â†’ get approval â†’ implement.

---

## Self-Check
- [ ] Matches task?
- [ ] Docs updated if needed?
- [ ] AICODE markers where needed?
- [ ] No hardcoded secrets?
- [ ] `await` before DB/API calls?

---
