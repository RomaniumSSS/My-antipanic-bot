# Antipanic Bot â€” Cursor Rules

## ğŸš¨ Read First
Before ANY action:
1. `docs/AGENTS.md` â€” initialization protocol
2. Relevant: `AIOGRAM_RULES.md` / `TORTOISE_RULES.md` / `OPENAI_RULES.md`

Start response: "âœ… Verified: [docs read]"

---

## Anti-Hallucination (Critical)

### aiogram 3.x
- âœ… `CallbackData` subclass (NOT raw strings)
- âœ… `@router.message(Command("start"))` (NOT `@dp.message_handler`)
- âœ… `F.text`, `F.from_user.id` for filters
- âŒ NEVER aiogram 2.x syntax

### Tortoise ORM
- âœ… `await User.get(...)` / `await Model.filter(...).prefetch_related(...)`
- âŒ NEVER forget `await` (returns coroutine)
- âŒ NEVER skip `prefetch_related` (causes N+1)

### OpenAI
- âœ… `AsyncOpenAI()` only
- âŒ NEVER sync client in async

Check `docs/AGENTS.md` Â§ 6-7 for details.

---

## Structure (Enforce)
```
src/bot/handlers/    # One router per flow
src/services/        # Business logic
src/core/            # Domain rules
src/storage/         # Repositories
```
âŒ NO files in root

---

## Code Style
- âœ… `async/await` for ALL I/O
- âœ… Type hints on all functions
- âœ… AICODE-NOTE/TODO/QUESTION for non-obvious code

---

## Plan Mode
Trigger if: multiple modules, DB changes, architecture shifts, new integrations.
Create `plans/NNN-objective.md` â†’ get approval â†’ implement.

---

## Self-Check
- [ ] Matches task?
- [ ] Docs updated if needed?
- [ ] AICODE markers where needed?
- [ ] No hardcoded secrets?
- [ ] `await` before DB/API calls?

---
